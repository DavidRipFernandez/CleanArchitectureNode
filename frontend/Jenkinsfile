pipeline {
    agent any

    stages {
        stage('Stop nginx process') {
            steps {
                powershell('net stop nginx')
            }
        }

        stage('Checkout Github Project') {
            steps {
                git(url: 'https://github.com/DavidRipFernandez/CleanArchitectureNode', branch: 'main')
            }
        }

        stage('Prepare Workspace') {
            steps {
                bat 'mkdir frontend-dev || echo "Directory exists"'
                bat 'mkdir frontend-test || echo "Directory exists"'
                bat 'mkdir frontend-staging || echo "Directory exists"'
                
                bat 'xcopy frontend\\* frontend-dev\\ /E /I /Y'
                bat 'xcopy frontend\\* frontend-test\\ /E /I /Y'
                bat 'xcopy frontend\\* frontend-staging\\ /E /I /Y'
            }
        }

        stage('Build & Deploy in Parallel') {
            parallel {
                stage('DEV') {
                    steps {
                        dir('frontend-dev') {
                            bat 'npm install'
                            bat 'npm run build:dev'
                        }
                        script {
                            def targetPath = "C:\\nginx\\html\\grupo-01\\dev\\"
                            powershell("Remove-Item -Path \"${targetPath}*\" -Recurse -Force -ErrorAction SilentlyContinue")
                            powershell("Copy-Item -Path \"${WORKSPACE}\\frontend\\build-dev\\*\" -Destination \"${targetPath}\" -Recurse -Force")
                        }
                    }
                }

                stage('TEST') {
                    steps {
                        dir('frontend-test') {
                            bat 'npm install'
                            bat 'npm run build:test'
                        }
                        script {
                            def targetPath = "C:\\nginx\\html\\grupo-01\\test\\"
                            powershell("Remove-Item -Path \"${targetPath}*\" -Recurse -Force -ErrorAction SilentlyContinue")
                            powershell("Copy-Item -Path \"${WORKSPACE}\\frontend-test\\build\\*\" -Destination \"${targetPath}\" -Recurse -Force")
                        }
                    }
                }

                stage('STAGING') {
                    steps {
                        dir('frontend-staging') {
                            bat 'npm install'
                            bat 'npm run build:staging'
                        }
                        script {
                            def targetPath = "C:\\nginx\\html\\grupo-01\\staging\\"
                            powershell("Remove-Item -Path \"${targetPath}*\" -Recurse -Force -ErrorAction SilentlyContinue")
                            powershell("Copy-Item -Path \"${WORKSPACE}\\frontend\\build-staging\\*\" -Destination \"${targetPath}\" -Recurse -Force")
                        }
                    }
                }
            }
        }

        stage('Start nginx process') {
            steps {
                powershell('net start nginx')
            }
        }

        stage('Cleanup') {
            steps {
                bat 'rmdir /S /Q frontend-dev'
                bat 'rmdir /S /Q frontend-test'
                bat 'rmdir /S /Q frontend-staging'
            }
        }
    }
}
